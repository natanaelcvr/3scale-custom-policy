= Token Instrospection Policy

This policy, call the instrospection policy, take the result, put it in the context.
It enables the policy to work with others builtin policies like Claim Check.

image::imgs/policy-flow.jpg[]

== Policy Deployment

JWE Token Instrospect

    oc create secret generic jwe-token-introspection \
        --from-file=./apicast-policy.json \
        --from-file=./init.lua \
        --from-file=./jwe-token-introspection.lua \
        --from-file=./tokens_cache.lua

Claim Check 

    oc create secret generic jwe-claim-check \
        --from-file=./apicast-policy.json \
        --from-file=./init.lua \
        --from-file=./jwt_claim_check.lua

Deploy the APICAST Gateway

. Install the `APICast Operator`
. Generate a token in 3Scale 
. Create a secret with the generated token 

    oc create secret generic 3scaleportal --from-literal=AdminPortalURL=https://f6d72b42f17dd38113af394404524febbe0903c4205740f8d0b5d3760151312b@3scale-admin.apps.cluster-b851.b851.sandbox243.opentlc.com
    # Change line 16 with your route URL
    oc create -f my-gateway.yml

Update the product staging gateway url to

    https://api-3scale-apicast-gateway.apps.cluster-b851.b851.sandbox243.opentlc.com:443

After you need to restart the gateway to load the changes

    ./redeploy.sh

== Deploy the police into the APICast policy registry

    cd policy
    TOKEN=f6d72b42f17dd38113af394404524febbe0903c4205740f8d0b5d3760151312b
    TSCALE_URL=3scale-admin.apps.cluster-b851.b851.sandbox243.opentlc.com
    curl -v -X POST -u ":$TOKEN" -H "Content-Type: application/json" \
        -d @apicast-policy.json \
        https://$TSCALE_URL/admin/api/registry/policies.json

Useful links:

https://github.com/3scale/APIcast/blob/master/doc/policies.md


== Testing

Import the `endpoint.postman_collection.json` into POSTMAN.

Remember to update the token with a valid one. 

== Cluster Credentials

https://console-openshift-console.apps.cluster-b851.b851.sandbox243.opentlc.com[Openshift URL]

username: `opentlc-mgr`

https://3scale-admin.apps.cluster-b851.b851.sandbox243.opentlc.com[3Scale]

user: `admin`

== Keycloak 

user: `admin`

=== Keycloak & 3Scale Integration 

RHSSO_FQDN=keycloak-3scale.apps.cluster-b851.b851.sandbox243.opentlc.com
RHSSO_PORT=443

Get Certificate 

    echo -n | openssl s_client -connect $RHSSO_FQDN:$RHSSO_PORT -servername $RHSSO_FQDN -showcerts | sed -ne '/-BEGIN CERTIFICATE-/,/-END CERTIFICATE-/p' > customCA.pem

Gather the existing content of `the /etc/pki/tls/cert.pem` file on the Zync pod. Run:

    curl -v https://$RHSSO_FQDN/auth/realms/master --cacert customCA.pem

Get ZYNC certificate 

    oc exec zync-que-1-fflqh cat /etc/pki/tls/cert.pem > zync.pem

Append the contents of the custom CA certificate file to zync.pem:

    cat customCA.pem >> zync.pem

Attach the new file to the Zync pod as ConfigMap:

    oc create configmap zync-ca-bundle --from-file=./zync.pem
    oc set volume dc/zync-que --add --name=zync-ca-bundle --mount-path /etc/pki/tls/zync/zync.pem --sub-path zync.pem --source='{"configMap":{"name":"zync-ca-bundle","items":[{"key":"zync.pem","path":"zync.pem"}]}}'
    oc set env dc/zync-que SSL_CERT_FILE=/etc/pki/tls/zync/zync.pem


=== Credentials

ClientID: `3scale`

Secret: `4c7f4881-1762-4fe4-820e-eeef76e5bd3b`

user: `ramalho`

pass: `redhat`

OIDC URL `https://3scale:4c7f4881-1762-4fe4-820e-eeef76e5bd3b@keycloak-3scale.apps.cluster-b851.b851.sandbox243.opentlc.com:443/auth/realms/master`

Well Known `https://keycloak-3scale.apps.cluster-b851.b851.sandbox243.opentlc.com:443/auth/realms/master/.well-known/openid-configuration`

Values relative from the application created in 3Scale.

Client ID: `40937863`
Client Secret: `e6753a5e9dddf12998e6fd4ecfd7aef7`

Token Introspection: `https://keycloak-3scale.apps.cluster-b851.b851.sandbox243.opentlc.com/auth/realms/master/protocol/openid-connect/token/introspect`